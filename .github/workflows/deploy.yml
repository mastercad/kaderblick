name: Deploy to Alfahosting

on:
  push:
    branches:
      - main

jobs:
  quality-assurance:
    uses: ./.github/workflows/qa.yml
    secrets: inherit

  deployment:
    runs-on: ubuntu-latest
    needs: quality-assurance
    timeout-minutes: 30

    steps:
      # ------------------------------
      # Checkout repository
      # ------------------------------
      - uses: actions/checkout@v3

      # ------------------------------
      # Cache Composer vendors
      # ------------------------------
      - name: Cache Composer vendors
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}

      # ------------------------------
      # Generate release directory
      # ------------------------------
      - name: Generate release directory name
        id: release
        run: echo "dir=${{ secrets.MAIN_PROJECT_PATH }}/releases/$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT

      # ------------------------------
      # Prepare build files
      # ------------------------------
      - name: Prepare files
        run: |
          mkdir -p build
          sh ./frontend/scripts/set-publish-date.sh
          cp -r docker-compose.yml docker-compose.db.yml .docker api frontend build/

      # ------------------------------
      # Create release directory for SCP
      # ------------------------------
      - name: Create release directory on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PLESK_HOST }}
          username: ${{ secrets.ROOT_USER }}
          password: ${{ secrets.ROOT_PASSWORD }}
          script: |
            set -e
            mkdir -p "${{ steps.release.outputs.dir }}"
            chmod 755 "${{ steps.release.outputs.dir }}"
            chown -R ${{ secrets.PLESK_USERNAME }}:psacln "${{ steps.release.outputs.dir }}"

      # ------------------------------
      # Copy build files to server
      # ------------------------------
      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.PLESK_HOST }}
          username: ${{ secrets.PLESK_USERNAME }}
          password: ${{ secrets.PLESK_PASSWORD }}
          source: "build/*"
          target: "${{ steps.release.outputs.dir }}"
          strip_components: 1

      # ------------------------------
      # Deploy secrets & JWT
      # ------------------------------
      - name: Deploy secrets & JWT
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PLESK_HOST }}
          username: ${{ secrets.ROOT_USER }}
          password: ${{ secrets.ROOT_PASSWORD }}
          script: |
            set -e
            RELEASE_DIR="${{ steps.release.outputs.dir }}"
            ROOT_DIR="${{ secrets.MAIN_PROJECT_PATH }}"

            mkdir -p "$RELEASE_DIR/api/config/secrets/prod"
            mkdir -p "$RELEASE_DIR/api/config/jwt"

            if [ -d "$ROOT_DIR/api/config/jwt" ]; then
              cp -r "$ROOT_DIR/api/config/jwt/"* "$RELEASE_DIR/api/config/jwt/" 2>/dev/null || true
            fi

            chmod -R 755 "$RELEASE_DIR/api" "$RELEASE_DIR/frontend"
            chown -R kaderblick-ftp-admin:psacln "$RELEASE_DIR"

      # ------------------------------
      # Prepare Docker environment & DB
      # ------------------------------
      - name: Ensure DB container is running
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PLESK_HOST }}
          username: ${{ secrets.ROOT_USER }}
          password: ${{ secrets.ROOT_PASSWORD }}
          script: |
            set -e
            RELEASE_DIR="${{ steps.release.outputs.dir }}"
            cd "$RELEASE_DIR"

            docker network inspect kaderblick-net >/dev/null 2>&1 || docker network create kaderblick-net
            docker volume inspect kaderblick-data >/dev/null 2>&1 || docker volume create kaderblick-data
            docker volume inspect kaderblick-db-data >/dev/null 2>&1 || docker volume create kaderblick-db-data

            if docker ps --filter "name=kaderblick-db" --filter "status=running" | grep -q kaderblick-db; then
              echo "DB Container läuft"
            else
              docker compose -f docker-compose.db.yml -p production up -d --build --force-recreate db
            fi

      # ------------------------------
      # Prepare .env files
      # ------------------------------
      - name: Prepare .env files
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PLESK_HOST }}
          username: ${{ secrets.ROOT_USER }}
          password: ${{ secrets.ROOT_PASSWORD }}
          script: |
            set -e
            RELEASE_DIR="${{ steps.release.outputs.dir }}"
            cd "$RELEASE_DIR"

            cp api/.env.dist api/.env
            sed -i 's/^APP_ENV=dev$/APP_ENV=prod/' api/.env

            echo "APP_SECRET=${{ secrets.APP_SECRET }}" >> api/.env
            echo "VITE_BACKEND_URL=https://api.kaderblick.byte-artist.de" > frontend/.env

            echo '${{ secrets.PROD_DECRYPT_KEY }}' | base64 -d > api/config/secrets/prod/prod.decrypt.private.php
            chmod 655 api/config/secrets/prod/prod.decrypt.private.php

      # ------------------------------
      # Build & start Staging
      # ------------------------------
      - name: Build & start Staging
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PLESK_HOST }}
          username: ${{ secrets.ROOT_USER }}
          password: ${{ secrets.ROOT_PASSWORD }}
          script: |
            set -e
            RELEASE_DIR="${{ steps.release.outputs.dir }}"
            cd "$RELEASE_DIR"

            docker compose -p staging down --remove-orphans api frontend
            PMA_PORT=18082 API_PORT=18081 REACT_PORT=18080 docker compose -p staging up -d --build --force-recreate api frontend

      # ------------------------------
      # Staging migrations & Composer
      # ------------------------------
      - name: Staging migrations & Composer
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PLESK_HOST }}
          username: ${{ secrets.ROOT_USER }}
          password: ${{ secrets.ROOT_PASSWORD }}
          script: |
            set -e
            RELEASE_DIR="${{ steps.release.outputs.dir }}"
            cd "$RELEASE_DIR"

            docker compose -p staging exec -T api composer install --no-dev --optimize-autoloader
            docker compose -p staging exec -T api bin/console doctrine:migrations:migrate --no-interaction --env=prod
            docker compose -p staging exec -T api bin/console secrets:decrypt-to-local --force --env=prod

            if [ ! -f api/config/jwt/private.pem ] || [ ! -f api/config/jwt/public.pem ]; then
              docker compose -p staging exec -T api php bin/console lexik:jwt:generate-keypair --overwrite
            fi

      # ------------------------------
      # Tag Images
      # ------------------------------
      - name: Tag Images
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PLESK_HOST }}
          username: ${{ secrets.ROOT_USER }}
          password: ${{ secrets.ROOT_PASSWORD }}
          script: |
            set -e
            RELEASE_DIR="${{ steps.release.outputs.dir }}"
            cd "$RELEASE_DIR"

            FRONTEND_IMAGE_ID=$(docker images staging-frontend:latest --format "{{.ID}}" | head -n 1)
            if [ -n "$FRONTEND_IMAGE_ID" ]; then
              docker tag $FRONTEND_IMAGE_ID production-frontend:latest
            fi
            API_IMAGE_ID=$(docker images staging-api:latest --format "{{.ID}}" | head -n 1)
            if [ -n "$API_IMAGE_ID" ]; then
              docker tag $API_IMAGE_ID production-api:latest
            fi

      # ------------------------------
      # Run Fixtures
      # ------------------------------
      - name: Run Fixtures
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PLESK_HOST }}
          username: ${{ secrets.ROOT_USER }}
          password: ${{ secrets.ROOT_PASSWORD }}
          script: |
            set -e
            RELEASE_DIR="${{ steps.release.outputs.dir }}"
            cd "$RELEASE_DIR"

            ###### WORKAROUND FÜR FIXTURES ######
            #            sed -i 's/^APP_ENV=prod$/APP_ENV=dev/' api/.env
            #            docker compose -p staging exec -T api env APP_ENV=dev composer install --dev
            #            echo "Spiele Fixtures für stammdaten ein"
            #            docker compose -p staging exec -T api bin/console doctrine:fixtures:load -n --group=master
            ###### ENDE WORKAROUND FÜR FIXTURES ######
            
            docker compose -p staging exec -T api env APP_ENV=dev composer install

            docker compose -p staging exec -T api bin/console doctrine:migrations:migrate --no-interaction --env=prod

            docker compose -p staging exec -T api composer install --no-dev --optimize-autoloader

      # ------------------------------
      # Prepare shared uploads symlinks
      # ------------------------------
      - name: Prepare uploads symlinks
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PLESK_HOST }}
          username: ${{ secrets.ROOT_USER }}
          password: ${{ secrets.ROOT_PASSWORD }}
          script: |
            set -e
            RELEASE_DIR="${{ steps.release.outputs.dir }}"
            SHARED_UPLOADS="${{ secrets.MAIN_PROJECT_PATH }}/public/uploads"
            CURRENT_DIR="${{ secrets.MAIN_PROJECT_PATH }}/current"

            mkdir -p "$SHARED_UPLOADS"
            chown -R www-data:www-data "$SHARED_UPLOADS"
            chmod -R 775 "$SHARED_UPLOADS"

            if [ -L "$CURRENT_DIR/public/uploads" ] || [ -d "$CURRENT_DIR/public/uploads" ]; then
                rm -rf "$CURRENT_DIR/public/uploads"
            fi

            if [ -L "$RELEASE_DIR/public/uploads" ] || [ -d "$RELEASE_DIR/public/uploads" ]; then
                rm -rf "$RELEASE_DIR/public/uploads"
            fi

            if [ -L "$CURRENT_DIR/api/public/uploads" ] || [ -d "$CURRENT_DIR/api/public/uploads" ]; then
                rm -rf "$CURRENT_DIR/api/public/uploads"
            fi

            if [ -L "$RELEASE_DIR/api/public/uploads" ] || [ -d "$RELEASE_DIR/api/public/uploads" ]; then
                rm -rf "$RELEASE_DIR/api/public/uploads"
            fi

            if [ -L "$CURRENT_DIR/frontend/public/uploads" ] || [ -d "$CURRENT_DIR/frontend/public/uploads" ]; then
                rm -rf "$CURRENT_DIR/frontend/public/uploads"
            fi

            if [ -L "$RELEASE_DIR/frontend/public/uploads" ] || [ -d "$RELEASE_DIR/frontend/public/uploads" ]; then
                rm -rf "$RELEASE_DIR/frontend/public/uploads"
            fi

            ln -s "$SHARED_UPLOADS" "$RELEASE_DIR/public/uploads"

      # ------------------------------
      # Activate Release (Zero-Downtime)
      # ------------------------------
      - name: Activate Release
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PLESK_HOST }}
          username: ${{ secrets.ROOT_USER }}
          password: ${{ secrets.ROOT_PASSWORD }}
          script: |
            set -e
            RELEASE_DIR="${{ steps.release.outputs.dir }}"
            CURRENT_DIR="${{ secrets.MAIN_PROJECT_PATH }}/current"

            docker compose -p production down --remove-orphans api frontend
            ln -sfn "$RELEASE_DIR" "$CURRENT_DIR"
            chmod -R 777 "$CURRENT_DIR/api/var"

            cd "$CURRENT_DIR"
            docker compose -p production up -d --force-recreate api frontend
            docker compose -p staging down api frontend
            docker compose -p staging rm api frontend

            # Cleanup old releases
            cd ../releases && ls -1dt * | tail -n +4 | xargs -r rm -rf
