{% extends 'base.html.twig' %}

{% block title %}
Event Kalender
{% endblock %}
        
{% block stylesheets %}
    {{ parent() }}
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.css' rel='stylesheet' />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href='/css/calendar.css' rel='stylesheet' />
{% endblock %}

{% block body %}
<div class="row">
    <div class="col-md-4">
        <!-- Filter vor der Event-Liste -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Filter nach Typ</h5>
            </div>
            <div class="card-body p-2">
                <div class="d-flex flex-wrap gap-2">
                    {% for type in eventTypes %}
                        <div class="form-check">
                            <input class="form-check-input event-type-filter" 
                                   type="checkbox" 
                                   value="{{ type.id }}" 
                                   id="type{{ type.id }}" 
                                   checked
                                   data-color="{{ type.color }}">
                            <label class="form-check-label event-type-filter-label" for="type{{ type.id }}"
                                   style="--event-color: {{ type.color }}">
                                {{ type.name }}
                            </label>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Anstehende Termine</h5>
                {% if is_granted('ROLE_ADMIN') %}
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newEventModal">
                        <i class="fas fa-plus"></i> Neuer Termin
                    </button>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="list-group">
                    <!-- Events werden per JavaScript geladen -->
                    <div class="text-center p-3">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Laden...</span>
                        </div>
                        <div class="ms-2 d-inline">Termine werden geladen...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

{% if is_granted('ROLE_ADMIN') %}
    <!-- Modal für neuen Termin -->
    <div class="modal fade" id="newEventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Neuer Termin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newEventForm" data-event-id="">
                        <div class="mb-3">
                            <label for="eventTitle" class="form-label">Titel</label>
                            <input type="text" class="form-control" id="eventTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="calendarEventType" class="form-label">Art</label>
                            <select class="form-select" id="calendarEventType" required>
                                {% for type in eventTypes %}
                                    <option value="{{ type.id }}" data-color="{{ type.color }}">{{ type.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="eventStart" class="form-label">Start</label>
                            <input type="datetime-local" class="form-control" id="eventStart" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventEnd" class="form-label">Ende (optional)</label>
                            <input type="datetime-local" class="form-control" id="eventEnd">
                        </div>

                        {# Spiel-spezifische Felder #}
                        <div id="gameFields" class="hidden">
                            <h3>Spieldetails</h3>
                            <div class="mb-3">
                                <label>Heimmannschaft</label>
                                <select name="homeTeamId" id="homeTeam" class="form-control game-field">
                                    <option value="">Bitte wählen...</option>
                                    {% for team in teams %}
                                        <option value="{{ team.id }}">{{ team.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label>Auswärtsmannschaft</label>
                                <select name="awayTeamId" id="awayTeam" class="form-control game-field">
                                    <option value="">Bitte wählen...</option>
                                    {% for team in teams %}
                                        <option value="{{ team.id }}">{{ team.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label>Spieltyp</label>
                                <select name="gameType" id="gameType" class="form-control game-field">
                                    <option value="">Bitte wählen...</option>
                                    {% for type in gameTypes %}
                                        <option value="{{ type.id }}">{{ type.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Ort</label>
                            <select id="eventLocation" name="eventLocation" class="form-control">
                                <option value="">kein Ort ausgewählt</option>
                                {% if locations %}
                                    {% for location in locations %}
                                        <option value="{{ location.id }}" selected>
                                            {{ location.name }}
                                        </option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="eventDescription" class="form-label">Beschreibung</label>
                            <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="sendNotification">
                            <label class="form-check-label" for="sendNotification">
                                Benachrichtigung an alle Mitglieder senden
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" id="saveEvent">Speichern</button>
                </div>
            </div>
        </div>
    </div>
{% endif %}

</div>
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/de.js'></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEventType = document.getElementById('calendarEventType');
        const gameFields = document.getElementById('gameFields');
        const gameFieldInputs = gameFields.querySelectorAll('select');

        const calendarEventTypeFilters = document.querySelectorAll('.event-type-filter');
        const editModal = document.getElementById('newEventModal')

        const urlParams = new URLSearchParams(window.location.search);
        const date = urlParams.get('date') || new Date().toISOString().slice(0, 10);

        const view = urlParams.get('view') || 'dayGridMonth';
        const fullCalendarView = 
            view === 'day' ? 'timeGridDay' :
            view === 'week' ? 'timeGridWeek' :
            view === 'month' ? 'dayGridMonth' :
            'dayGridMonth';

        const calendarGameEventTypeId = '{{ calendarGameEventTypeId }}';
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: fullCalendarView,
            initialDate: date,
            locale: 'de',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: '{{ path('calendar_events') }}',
            editable: {{ is_granted('ROLE_ADMIN') ? 'true' : 'false' }},
            eventDidMount: function(info) {
                // Zeige Events farbig an basierend auf EventType
                if (info.event.extendedProps.type) {
                    info.el.style.backgroundColor = info.event.extendedProps.type.color;
                }
                // Setze das Ende auf 23:59:59 wenn kein Ende definiert ist
                if (!info.event.end) {
                    const endDate = new Date(info.event.start);
                    endDate.setHours(23, 59, 59);
                    info.event.setEnd(endDate);
                }
                // Tooltip mit Details
                new bootstrap.Tooltip(info.el, {
                    title: `${info.event.title}\n${info.event.extendedProps.location?.name || ''}\n${info.event.extendedProps.description || ''}`,
                    placement: 'top',
                    html: true
                });
            },
            eventDrop: async function(info) {
                try {
                    const response = await fetch(`/calendar/event/${info.event.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': '{{ csrf_token('update-event') }}'
                        },
                        body: JSON.stringify({
                            id: info.event.id,
                            startDate: info.event.start.toISOString(),
                            endDate: info.event.end?.toISOString()
                        })
                    });
                    
                    if (!response.ok) {
                        info.revert();
                        alert('Fehler beim Aktualisieren des Termins');
                    } else {
                        await updateUpcomingEvents();
                    }
                } catch (error) {
                    info.revert();
                    alert('Fehler beim Aktualisieren des Termins');
                }
            },
            slotMinTime: '06:00:00', // Tag beginnt um 6 Uhr
            slotMaxTime: '24:00:00', // Tag endet um 24 Uhr
            slotDuration: '00:30:00', // 30-Minuten-Slots
            allDaySlot: false, // Keine Ganztages-Zeile
            expandRows: true, // Höhe an verfügbaren Platz anpassen
            dateClick: function(info) {
                // Öffne Tagesansicht bei Klick auf einen Tag
                calendar.changeView('timeGridDay', info.dateStr);
            },
            eventClick: function(info) {
                // Event-Details anzeigen
                showEventDetails(info.event);
            }
        });
        calendar.render();

        // Funktion zum Formatieren des Datums ohne Sekunden
        function formatDateTime(date) {
            return new Date(date).toLocaleString('de-DE', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        // Event Handler für den Speichern-Button
        document.getElementById('saveEvent')?.addEventListener('click', async function() {
            const calendarEventTypeId = document.getElementById('calendarEventType').value;
            const formData = {
                title: document.getElementById('eventTitle').value,
                typeId: calendarEventTypeId,
                startDate: document.getElementById('eventStart').value,
                endDate: document.getElementById('eventEnd').value || null,
                locationId: document.getElementById('eventLocation').value || null,
                description: document.getElementById('eventDescription').value,
                sendNotification: document.getElementById('sendNotification').checked
            };

            if (calendarGameEventTypeId == calendarEventTypeId) {
                formData['awayTeamId'] = document.getElementById('awayTeam').value,
                formData['homeTeamId'] = document.getElementById('homeTeam').value,
                formData['gameTypeId'] = document.getElementById('gameType').value
            }

            const currentEventId = document.getElementById('newEventForm').dataset.eventId;
            const method = currentEventId ? 'PUT' : 'POST';
            const url = currentEventId 
                ? `/calendar/event/${currentEventId}`
                : '{{ path('calendar_event_create') }}';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': '{{ csrf_token('update-event') }}'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    calendar.refetchEvents();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newEventModal'));
                    modal.hide();
                    document.getElementById('newEventForm').reset();
                    document.getElementById('newEventForm').dataset.eventId = '';
                    await updateUpcomingEvents();
                } else {
                    alert('Fehler beim Speichern: ' + (result.error || 'Unbekannter Fehler'));
                }
            } catch (error) {
                alert('Fehler beim Speichern');
                console.error(error);
            }
        });

        // Funktion zum Aktualisieren der Event-Liste
        async function updateUpcomingEvents() {
            const response = await fetch('{{ path('calendar_upcoming') }}');
            const events = await response.json();
            console.log('Received events:', events);
            
            const listGroup = document.querySelector('.list-group');
            if (!listGroup) {
                console.error('List group element not found!');
                return;
            }
            
            const html = events.map(event => {
                console.log('Processing event:', event);
                
                // Titel für Spiele generieren
                let displayTitle = event.title || 'Unbenanntes Event';
                if (event.game && event.game.homeTeam && event.game.awayTeam) {
                    displayTitle = `${event.game.gameType?.name || 'Spiel'}: ${event.game.homeTeam.name} vs ${event.game.awayTeam.name}`;
                }
                
                // Farben für dezente Gestaltung - gleiche Farben wie im Kalender
                const eventColor = event.calendarEventType?.color || '#6c757d';
                
                return `
                <div class="list-group-item list-group-item-action event-list-item" role="button"
                     style="--event-color: ${eventColor}"
                     data-event='${JSON.stringify({
                        id: event.id,
                        title: event.title,
                        description: event.description,
                        start: event.startDate,
                        end: event.endDate,
                        type: event.calendarEventType,
                        location: event.location,
                        game: event.game
                    })}'>
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${displayTitle}</h6>
                        <small>${formatDateTime(event.startDate)}</small>
                    </div>
                    <p class="mb-1">${event.description || ''}</p>
                    ${event.location ? `<small><i class="fas fa-map-marker-alt"></i> ${event.location.name}</small>` : ''}
                </div>
                `;
            });
            
            listGroup.innerHTML = html.join('');

            // Fade-in Animation für die neuen Elemente
            document.querySelectorAll('.list-group-item').forEach((item, index) => {
                item.classList.add('fade-in');
                item.style.animationDelay = `${index * 0.1}s`;
            });

            // Event-Handler nach Update neu hinzufügen
            document.querySelectorAll('.list-group-item-action').forEach(item => {
                item.addEventListener('click', function() {
                    const eventData = JSON.parse(this.dataset.event);
                    
                    // Titel für Spiele generieren
                    let displayTitle = eventData.title;
                    if (eventData.game && eventData.game.homeTeam && eventData.game.awayTeam) {
                        displayTitle = `${eventData.game.gameType?.name || 'Spiel'}: ${eventData.game.homeTeam.name} vs ${eventData.game.awayTeam.name}`;
                    }
                    
                    showEventDetails({
                        id: eventData.id,
                        title: displayTitle,
                        start: new Date(eventData.start),
                        end: eventData.end ? new Date(eventData.end) : null,
                        extendedProps: {
                            description: eventData.description,
                            type: eventData.type,
                            location: eventData.location,
                            game: eventData.game
                        }
                    });
                });
            });

            // Nach dem Update die Filter erneut anwenden
            updateEventVisibility();
        }

        // Event-Details Modal
        function showEventDetails(event) {
            const modalElement = document.getElementById('eventDetailsModal');
            if (!modalElement) {
                console.error('Modal element not found');
                return;
            }
            
            modalElement.dataset.eventId = event.id; // Event ID speichern
            
            // Modal Instanz abrufen oder erstellen
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            
            // Titel für Spiele generieren
            let displayTitle = event.title;
            if (event.extendedProps.game && event.extendedProps.game.homeTeam && event.extendedProps.game.awayTeam) {
                displayTitle = `${event.extendedProps.game.gameType?.name || 'Spiel'}: ${event.extendedProps.game.homeTeam.name} vs ${event.extendedProps.game.awayTeam.name}`;
            }
            
            document.getElementById('eventDetailsTitle').textContent = displayTitle;
            
            // Event-Type anzeigen
            if (event.extendedProps.type) {
                const typeElement = document.getElementById('eventDetailsType');
                typeElement.textContent = event.extendedProps.type.name;
                typeElement.style.color = event.extendedProps.type.color;
                typeElement.style.fontWeight = 'bold';
            }
            
            document.getElementById('eventDetailsDate').textContent = 
                `${formatDateTime(event.start)}${event.end ? ' - ' + formatDateTime(event.end) : ''}`;
            document.getElementById('eventDetailsDescription').textContent = event.extendedProps.description || '';
            if (event.extendedProps.location) {
                document.getElementById('eventDetailsLocation').textContent = event.extendedProps.location.name;
                document.getElementById('eventDetailsLocationContainer').style.display = 'block';
            } else {
                document.getElementById('eventDetailsLocationContainer').style.display = 'none';
            }

            // Event-Type Farbe im Modal anzeigen
            if (event.extendedProps.type) {
                document.getElementById('eventDetailsTitle').style.color = event.extendedProps.type.color;
            }

            // Tooltip für Details
            const isAdmin = {{ is_granted('ROLE_ADMIN') ? 'true' : 'false' }};
            new bootstrap.Tooltip(document.getElementById('eventDetailsDate'), {
                title: 'Klicken Sie zum Bearbeiten',
                placement: 'top',
                enabled: isAdmin
            });

            // Event-Buttons für Admins
            document.getElementById('editEvent')?.addEventListener('click', () => {
                console.info(event);
                document.getElementById('newEventForm').dataset.eventId = event.id;
                document.getElementById('eventTitle').value = event.title;
                document.getElementById('calendarEventType').value = event.extendedProps.type?.id;
                document.getElementById('eventStart').value = event.start.toISOString().slice(0, 16);
                if (event.end) {
                    document.getElementById('eventEnd').value = event.end.toISOString().slice(0, 16);
                }
                document.getElementById('eventLocation').value = event.extendedProps.location?.id || '';
                document.getElementById('eventDescription').value = event.extendedProps.description || '';
                document.getElementById('homeTeam').value = event.extendedProps.game?.homeTeam?.id;
                document.getElementById('awayTeam').value = event.extendedProps.game?.awayTeam?.id;
                document.getElementById('gameType').value = event.extendedProps.game?.gameType?.id;
                
                modal.hide();
                new bootstrap.Modal(document.getElementById('newEventModal')).show();
            }, { once: true }); // Wichtig: Event-Listener nur einmal ausführen!

            document.getElementById('deleteEvent')?.addEventListener('click', async () => {
                if (confirm('Möchten Sie diesen Termin wirklich löschen?')) {
                    try {
                        const response = await fetch(`/calendar/event/${event.id}`, {
                            method: 'DELETE',
                            headers: {
                                'X-CSRF-TOKEN': '{{ csrf_token('delete-event') }}'
                            }
                        });
                        
                        if (response.ok) {
                            calendar.getEventById(event.id).remove();
                            modal.hide();
                            updateUpcomingEvents();
                        }
                    } catch (error) {
                        alert('Fehler beim Löschen des Termins');
                    }
                }
            });

            // Teilnahme-Daten laden
            loadParticipationData(event.id);

            modal.show();
        }

        // Teilnahme-Daten laden
        async function loadParticipationData(eventId) {
            try {
                // Verfügbare Status laden
                const statusResponse = await fetch('/api/participation/statuses');
                const statusData = await statusResponse.json();
                
                const statusSelect = document.getElementById('participationStatusSelect');
                statusSelect.innerHTML = '<option value="">Status wählen...</option>';
                statusData.statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.id;
                    option.textContent = status.name;
                    statusSelect.appendChild(option);
                });

                // Event-Teilnahmen laden
                const participationResponse = await fetch(`/api/participation/event/${eventId}`);
                const participationData = await participationResponse.json();
                
                // Eigenen Status anzeigen
                const currentUserId = {{ app.user ? app.user.id : 'null' }};
                const currentUser = participationData.participations.find(p => p.user_id === currentUserId);
                if (currentUser && currentUser.status) {
                    const statusBadge = document.getElementById('currentParticipationStatus');
                    statusBadge.textContent = currentUser.status.name;
                    statusBadge.className = `badge`;
                    statusBadge.style.backgroundColor = currentUser.status.color;
                    
                    // Status im Select vorauswählen
                    statusSelect.value = currentUser.status.id;
                    
                    // Notiz anzeigen
                    if (currentUser.note) {
                        document.getElementById('participationNoteText').textContent = currentUser.note;
                        document.getElementById('participationNote').style.display = 'block';
                        document.getElementById('participationNoteInput').value = currentUser.note;
                    }
                } else {
                    document.getElementById('currentParticipationStatus').textContent = 'Keine Angabe';
                    document.getElementById('currentParticipationStatus').className = 'badge bg-secondary';
                }

                // Teilnehmerliste anzeigen
                displayParticipantsList(participationData.participations);

            } catch (error) {
                console.error('Fehler beim Laden der Teilnahme-Daten:', error);
                document.getElementById('participantsList').innerHTML = '<p class="text-danger">Fehler beim Laden der Teilnahmen</p>';
            }
        }

        // Teilnehmerliste anzeigen
        function displayParticipantsList(participations) {
            const container = document.getElementById('participantsList');
            
            if (participations.length === 0) {
                container.innerHTML = '<p class="text-muted">Noch keine Teilnahmen</p>';
                return;
            }

            // Nach Status gruppieren
            const grouped = participations.reduce((acc, p) => {
                if (p.status) {
                    const statusName = p.status.name;
                    if (!acc[statusName]) acc[statusName] = [];
                    acc[statusName].push(p);
                }
                return acc;
            }, {});

            let html = '';
            Object.entries(grouped).forEach(([statusName, users]) => {
                const status = users[0].status;
                html += `
                    <div class="mb-2">
                        <h6>
                            <span class="badge event-badge" style="--event-color: ${status.color}">
                                ${status.icon ? `<i class="fa fa-${status.icon}"></i> ` : ''}${statusName} (${users.length})
                            </span>
                        </h6>
                        <ul class="list-unstyled ms-3">
                `;
                users.forEach(user => {
                    html += `
                        <li class="d-flex align-items-center mb-1">
                            <small>
                                ${user.user_name}
                                ${user.is_team_player ? '<span class="badge bg-primary ms-1">Spieler</span>' : ''}
                                ${user.note ? `<br><em class="text-muted">"${user.note}"</em>` : ''}
                            </small>
                        </li>
                    `;
                });
                html += '</ul></div>';
            });

            container.innerHTML = html;
        }

        // Teilnahme speichern
        document.getElementById('saveParticipation')?.addEventListener('click', async function() {
            const eventId = document.querySelector('#eventDetailsModal').dataset.eventId;
            const statusId = document.getElementById('participationStatusSelect').value;
            const note = document.getElementById('participationNoteInput').value;

            if (!statusId) {
                alert('Bitte wählen Sie einen Status aus.');
                return;
            }

            try {
                const response = await fetch(`/api/participation/event/${eventId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        status_id: statusId,
                        note: note
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // Teilnahme-Daten neu laden
                    await loadParticipationData(eventId);
                    
                    // Erfolgsmeldung
                    const button = this;
                    const originalText = button.textContent;
                    button.textContent = 'Gespeichert!';
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-success');
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('btn-success');
                        button.classList.add('btn-primary');
                    }, 2000);
                } else {
                    alert(result.error || 'Fehler beim Speichern');
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Speichern der Teilnahme');
            }
        });
        
        const updateEventVisibility = () => {
            const selectedTypes = Array.from(calendarEventTypeFilters)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            // Filter-Status im localStorage speichern
            localStorage.setItem('calendarEventTypeFilters', JSON.stringify(selectedTypes));

            // Kalender Events filtern
            calendar.getEvents().forEach(event => {
                const typeId = event.extendedProps.type?.id?.toString();
                const visible = selectedTypes.includes(typeId);
                event.setProp('display', visible ? 'auto' : 'none');
            });

            // Upcoming Events filtern
            document.querySelectorAll('.list-group-item-action').forEach(item => {
                const eventData = JSON.parse(item.dataset.event);
                const typeId = eventData.type?.id?.toString();
                const visible = selectedTypes.includes(typeId);
                item.style.display = visible ? 'block' : 'none';
            });
        };

        // Filter-Status aus localStorage laden und anwenden
        const loadFilterSettings = () => {
            const savedFilters = localStorage.getItem('calendarEventTypeFilters');
            if (savedFilters) {
                const selectedTypes = JSON.parse(savedFilters);
                calendarEventTypeFilters.forEach(checkbox => {
                    checkbox.checked = selectedTypes.includes(checkbox.value);
                });
            }
            // Filter anwenden
            updateEventVisibility();
        };

        calendarEventTypeFilters.forEach(checkbox => {
            checkbox.addEventListener('change', updateEventVisibility);
        });

        // Filter beim Laden der Seite wiederherstellen
        loadFilterSettings();

        // Event-Handler für Upcoming Events
        document.querySelectorAll('.list-group-item-action').forEach(item => {
            item.addEventListener('click', function() {
                const eventData = JSON.parse(this.dataset.event);
                showEventDetails({
                    id: eventData.id,
                    title: eventData.title,
                    start: new Date(eventData.start),
                    end: eventData.end ? new Date(eventData.end) : null,
                    extendedProps: {
                        description: eventData.description,
                        type: eventData.type,
                        location: eventData.location
                    }
                });
            });
        });

        calendarEventType.addEventListener('change', function() {
            const isGame = this.options[this.selectedIndex].value == calendarGameEventTypeId;
            gameFields.style.display = isGame ? 'block' : 'none';
            gameFieldInputs.forEach(input => input.required = isGame);
        });

        function initSelect2(elementId, searchType, placeholder) {
            $(elementId).select2({
                ajax: {
                    url: "{{ path('calendar_search_locations') }}",
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            term: params.term || ''
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.map(function(location) {
                                return {
                                    id: location.id,
                                    text: location.name + ', ' + location.city,
                                };
                            })
                        };
                    },
                    cache: true
                },
                dropdownParent: $("#newEventModal"),
                minimumInputLength: 2,
                placeholder: placeholder,
                width: '100%',
                allowClear: true
            }).on('select2:unselecting', function() {
                $(this).val('').trigger('change');
            });

            var $emptyOption = new Option('Keine Zuordnung', '', true, false);
            $(elementId).append($emptyOption).trigger('change');
        }

        initSelect2('#eventLocation', 'location', 'Ort suchen...');

        editModal.addEventListener('shown.bs.modal', function (event) {
            const isGame = calendarEventType.options[calendarEventType.selectedIndex].value == calendarGameEventTypeId;
            gameFields.style.display = isGame ? 'block' : 'none';
            gameFieldInputs.forEach(input => input.required = isGame);
        });

        // Events beim Laden der Seite laden
        updateUpcomingEvents();
    });
    </script>
{% endblock %}

{% block additional_content %}
{# Event-Details Modal außerhalb der Container für korrekten Z-Index #}
<div class="modal fade" id="eventDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventDetailsTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Typ:</strong> <span id="eventDetailsType"></span></p>
                        <p><strong>Termin:</strong> <span id="eventDetailsDate"></span></p>
                        <div id="eventDetailsLocationContainer">
                            <p><strong>Ort:</strong> <span id="eventDetailsLocation"></span></p>
                        </div>
                        <p><strong>Beschreibung:</strong></p>
                        <p id="eventDetailsDescription"></p>
                    </div>
                    <div class="col-md-6">
                        <div id="participationSection">
                            <h6>Teilnahme</h6>
                            <div id="participationStatus" class="mb-3">
                                <p>Ihr Status: <span id="currentParticipationStatus" class="badge"></span></p>
                                <div id="participationNote" class="hidden">
                                    <small class="text-muted" id="participationNoteText"></small>
                                </div>
                            </div>
                            <div id="participationForm">
                                <div class="mb-3">
                                    <label for="participationStatusSelect" class="form-label">Status ändern:</label>
                                    <select class="form-select" id="participationStatusSelect">
                                        <option value="">Laden...</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="participationNoteInput" class="form-label">Notiz (optional):</label>
                                    <textarea class="form-control" id="participationNoteInput" rows="2" placeholder="Zusätzliche Informationen..."></textarea>
                                </div>
                                <button type="button" class="btn btn-primary btn-sm" id="saveParticipation">
                                    Status speichern
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Teilnehmerliste -->
                <div class="mt-4">
                    <h6>Teilnehmerliste</h6>
                    <div id="participantsList">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Laden...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% if is_granted('ROLE_ADMIN') %}
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="deleteEvent">Löschen</button>
                <button type="button" class="btn btn-primary" id="editEvent">Bearbeiten</button>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
