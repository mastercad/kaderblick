<nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
    <div class="container">
        <a class="navbar-brand fw-bold navbar-brand-kaderblick" href="{{ path('app_dashboard_index') }}">
            <i class="fas fa-futbol me-2"></i>Kaderblick
        </a>
        <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">

                {# Gäste: nur öffentliche Menüpunkte #}
                {% if not is_granted('IS_AUTHENTICATED_FULLY') %}
                    <li class="nav-item"><a class="nav-link nav-link-kaderblick{% if app.request.attributes.get('_route') starts with 'api_calendar' %} active{% endif %}" href="{{ path('api_calendar_index') }}"><i class="fas fa-calendar-alt me-1"></i>Kalender</a></li>
                    <li class="nav-item"><a class="nav-link nav-link-kaderblick{% if app.request.attributes.get('_route') starts with 'api_teams' %} active{% endif %}" href="{{ path('api_teams_index') }}"><i class="fas fa-users me-1"></i>Teams</a></li>
                    <li class="nav-item"><a class="nav-link nav-link-kaderblick{% if app.request.attributes.get('_route') starts with 'games_' %} active{% endif %}" href="{{ path('games_index') }}"><i class="fas fa-trophy me-1"></i>Spiele</a></li>
                    <li class="nav-item"><a class="nav-link nav-link-kaderblick{% if app.request.attributes.get('_route') starts with 'locations_' %} active{% endif %}" href="{{ path('locations_index') }}"><i class="fas fa-map-marker-alt me-1"></i>Spielstätten</a></li>
                {% else %}
                    {# Eingeloggte User: gemeinsame Menüpunkte #}
                    <li class="nav-item"><a class="nav-link nav-link-kaderblick{% if app.request.attributes.get('_route') == 'api_calendar_index' %} active{% endif %}" href="{{ path('api_calendar_index') }}"><i class="fas fa-calendar-alt me-1"></i>Kalender</a></li>
                    <li class="nav-item"><a class="nav-link nav-link-kaderblick{% if app.request.attributes.get('_route') == 'api_teams_index' %} active{% endif %}" href="{{ path('api_teams_index') }}"><i class="fas fa-users me-1"></i>Teams</a></li>
                    <li class="nav-item"><a class="nav-link nav-link-kaderblick{% if app.request.attributes.get('_route') == 'games_index' %} active{% endif %}" href="{{ path('games_index') }}"><i class="fas fa-trophy me-1"></i>Spiele</a></li>
                    <li class="nav-item"><a class="nav-link nav-link-kaderblick{% if app.request.attributes.get('_route') == 'locations_index' %} active{% endif %}" href="{{ path('locations_index') }}"><i class="fas fa-map-marker-alt me-1"></i>Spielstätten</a></li>

                    {# Reports: für alle eingeloggten User #}
                    <li class="nav-item"><a class="nav-link nav-link-kaderblick{% if app.request.attributes.get('_route') starts with 'app_report' %} active{% endif %}" href="{{ path('app_report_list') }}"><i class="fas fa-chart-bar me-1"></i>Reports</a></li>

                    {# Spieler-Relation: eigene Spielereignisse und Spielerübersicht #}
                    {% if app.user and app.user.userRelations is defined and app.user.userRelations|filter(r => r.type == 'spieler')|length > 0 %}
                        <li class="nav-item"><a class="nav-link nav-link-kaderblick{% if app.request.attributes.get('_route') == 'api_game_events_index' %} active{% endif %}" href="{{ path('api_game_events_index') }}"><i class="fas fa-clipboard-list me-1"></i>Meine Spielereignisse</a></li>
                        <li class="nav-item"><a class="nav-link nav-link-kaderblick{% if app.request.attributes.get('_route') == 'api_players_index' %} active{% endif %}" href="{{ path('api_players_index') }}"><i class="fas fa-id-card me-1"></i>Spielerübersicht</a></li>
                    {% endif %}

                    {# Coach-Relation: Mannschaften, Aufstellungen, Spieler, Spielereignisse, Ereignistypen #}
                    {% if app.user and app.user.userRelations is defined and app.user.userRelations|filter(r => r.type == 'coach')|length > 0 %}
                        <li class="nav-item"><a class="nav-link nav-link-kaderblick{% if app.request.attributes.get('_route') == 'api_teams_index' %} active{% endif %}" href="{{ path('api_teams_index') }}"><i class="fas fa-users me-1"></i>Mannschaften</a></li>
                        <li class="nav-item"><a class="nav-link nav-link-kaderblick{% if app.request.attributes.get('_route') == 'formations_index' %} active{% endif %}" href="{{ path('formations_index') }}"><i class="fas fa-th me-1"></i>Aufstellungen</a></li>
                        <li class="nav-item"><a class="nav-link nav-link-kaderblick{% if app.request.attributes.get('_route') == 'api_players_index' %} active{% endif %}" href="{{ path('api_players_index') }}"><i class="fas fa-running me-1"></i>Spieler</a></li>
                        <li class="nav-item"><a class="nav-link nav-link-kaderblick{% if app.request.attributes.get('_route') == 'api_game_events_index' %} active{% endif %}" href="{{ path('api_game_events_index') }}"><i class="fas fa-clipboard-list me-1"></i>Spielereignisse</a></li>
                        <li class="nav-item"><a class="nav-link nav-link-kaderblick{% if app.request.attributes.get('_route') == 'api_game_event_types_index' %} active{% endif %}" href="{{ path('api_game_event_types_index') }}"><i class="fas fa-tags me-1"></i>Ereignistypen</a></li>
                    {% endif %}
                {% endif %}

                {# Admin-Endpunkte #}
                {% if is_granted('ROLE_ADMIN') or is_granted('ROLE_SUPERADMIN') %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle nav-link-kaderblick" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-cog me-1"></i>Administration
                        </a>
                        <ul class="dropdown-menu dropdown-menu-custom min-w-250">
                            <li><h6 class="dropdown-header text-primary"><i class="fas fa-database me-1"></i>Stammdaten</h6></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'api_age_groups' %} active{% endif %}" href="{{ path('api_age_groups_index') }}"><i class="fas fa-users me-2 text-muted"></i>Altersgruppen</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'api_positions' %} active{% endif %}" href="{{ path('api_positions_index') }}"><i class="fas fa-crosshairs me-2 text-muted"></i>Positionen</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'api_strong_feet' %} active{% endif %}" href="{{ path('api_strong_feet_index') }}"><i class="fas fa-shoe-prints me-2 text-muted"></i>Füße</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'api_surface_types' %} active{% endif %}" href="{{ path('api_surface_types_index') }}"><i class="fas fa-layer-group me-2 text-muted"></i>Beläge</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'api_game_event_types' %} active{% endif %}" href="{{ path('api_game_event_types_index') }}"><i class="fas fa-tags me-2 text-muted"></i>Ereignistypen</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header text-success"><i class="fas fa-tools me-1"></i>Verwaltung</h6></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'club_' %} active{% endif %}" href="{{ path('club_list') }}"><i class="fas fa-shield-alt me-2 text-muted"></i>Vereine</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'api_coaches' %} active{% endif %}" href="{{ path('api_coaches_index') }}"><i class="bi bi-person-badge me-2 text-muted"></i>Trainer</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'api_players' %} active{% endif %}" href="{{ path('api_players_index') }}"><i class="bi bi-person-fill me-2 text-muted"></i>Spieler</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'locations_' %} active{% endif %}" href="{{ path('locations_index') }}"><i class="fas fa-map-marker-alt me-2 text-muted"></i>Spielstätten</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'api_teams' %} active{% endif %}" href="{{ path('api_teams_index') }}"><i class="fas fa-users me-2 text-muted"></i>Teams</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'admin_feedback' %} active{% endif %}" href="{{ path('admin_feedback_index') }}"><i class="fas fa-comments me-2 text-muted"></i>Feedback</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'app_news' %} active{% endif %}" href="{{ path('app_news_index') }}"><i class="fas fa-newspaper me-2 text-muted"></i>Neuigkeiten Management</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'admin_consistency' %} active{% endif %}" href="{{ path('admin_consistency_index') }}"><i class="fas fa-search me-2 text-muted"></i>Datenkonsistenz</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'formations_' %} active{% endif %}" href="{{ path('formations_index') }}"><i class="fas fa-users me-2 text-muted"></i>Aufstellungen</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header text-warning"><i class="fas fa-link me-1"></i>Zuweisungen</h6></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'admin_users_index' %} active{% endif %}" href="{{ path('admin_users_index') }}"><i class="fas fa-user-cog me-2 text-muted"></i>Benutzer</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'api_player_team_assignments_index' %} active{% endif %}" href="{{ path('api_player_team_assignments_index') }}"><i class="fas fa-user-plus me-2 text-muted"></i>Spieler zu Team</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'api_player_club_assignments_index' %} active{% endif %}" href="{{ path('api_player_club_assignments_index') }}"><i class="fas fa-handshake me-2 text-muted"></i>Spieler zu Verein</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'api_coach_team_assignments_index' %} active{% endif %}" href="{{ path('api_coach_team_assignments_index') }}"><i class="bi bi-arrow-left-right me-2 text-muted"></i>Coach zu Team</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'api_coach_club_assignments_index' %} active{% endif %}" href="{{ path('api_coach_club_assignments_index') }}"><i class="fas fa-building me-2 text-muted"></i>Coach zu Verein</a></li>
                            <li><a class="dropdown-item py-1{% if app.request.attributes.get('_route') starts with 'videos_upload_form' %} active{% endif %}" href="{{ path('videos_upload_form') }}"><i class="fas fa-video me-2 text-muted"></i>Videos</a></li>
                        </ul>
                    </li>
                {% endif %}
                
                {# Mobile: Utility-Links im collapsed menu - NUR für eingeloggte User #}
                {% if is_granted('ROLE_USER') %}
                    <li class="nav-item d-lg-none">
                        <hr class="dropdown-divider my-2">
                    </li>
                    <li class="nav-item d-lg-none">
                        <a class="nav-link" href="{{ path('messages_index') }}">
                            <i class="fas fa-envelope me-2"></i>Nachrichten
                            <span class="badge bg-danger rounded-pill ms-1 d-none" id="mobile_unread_messages_count"></span>
                        </a>
                    </li>
                    <li class="nav-item d-lg-none">
                        <button class="nav-link btn btn-link w-100 text-start justify-content-start" data-bs-toggle="modal" data-bs-target="#profile_modal">
                            <i class="fas fa-user me-2"></i>Profil
                        </button>
                    </li>
                    <li class="nav-item d-lg-none">
                        <button class="nav-link text-danger btn btn-navbar-logout w-100 text-start justify-content-start" id="button_logout">
                            <i class="fas fa-sign-out-alt me-2"></i>
                            Abmelden
                        </button>
                    </li>
                {% else %}
                    {# Login Button für Gäste #}
                    <li class="nav-item d-lg-none">
                        <button class="nav-link btn btn-link w-100 text-start justify-content-start" onclick="const modalManager = (window.modalManager || window.ModalManager); modalManager.showModal('auth_modal')">
                            <i class="fas fa-sign-in-alt me-1"></i>
                            Anmelden
                        </button>
                    </li>
                {% endif %}
                
                {# PWA Install für alle #}
                <li class="nav-item d-lg-none">
                    <button class="nav-link btn btn-link w-100 text-start pwa-install-button justify-content-start" id="mobile_installPWA">
                        <i class="fas fa-download me-2"></i>App installieren
                    </button>
                </li>
            </ul>
            
            {# Desktop: Utility-Icons rechts #}
            <ul class="navbar-nav d-none d-lg-flex">
                {# Glass Theme Toggle #}
                <li class="nav-item me-2 mt-2">
                    <button class="btn btn-outline-light btn-sm circle" id="glass-toggle" title="Glass-Theme umschalten">
                        <i class="fas fa-palette"></i>
                    </button>
                </li>
                
                {# PWA Install #}
                <li class="nav-item me-2 mt-2">
                    <button class="btn btn-outline-light btn-sm circle" id="installPWA" title="App installieren">
                        <i class="fas fa-download"></i>
                    </button>
                </li>
                
                {% if is_granted('ROLE_USER') %}
                    {# Nachrichten für eingeloggte User #}
                    <li class="nav-item me-2 mt-2">
                        <button class="btn btn-outline-light btn-sm circle position-relative" onclick="window.location.href='{{ path('messages_index') }}'" title="Nachrichten">
                            <i class="fas fa-envelope"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" id="unread_messages_count">
                                <span class="visually-hidden">ungelesene Nachrichten</span>
                            </span>
                        </button>
                    </li>
                    
                    {# User Dropdown #}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user me-1"></i>
                            <span>{{ app.user.firstName ?? app.user.email }}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-custom">
                            <li>
                                <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#profile_modal">
                                    <i class="fas fa-user me-2"></i>
                                    Profil bearbeiten
                                </button>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <button class="dropdown-item text-danger btn btn-navbar-logout">
                                    <i class="fas fa-sign-out-alt me-2"></i>
                                    Abmelden
                                </button>
                            </li>
                        </ul>
                    </li>
                {% else %}
                    {# Login Button für Gäste #}
                    <li class="nav-item">
                        <button class="btn btn-light" onclick="const modalManager = (window.modalManager || window.ModalManager); modalManager.showModal('auth_modal')">
                            <i class="fas fa-sign-in-alt me-1"></i>
                            Anmelden
                        </button>
                    </li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>
