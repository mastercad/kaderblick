<div class="report-widget position-relative">
    <div class="d-flex align-items-center mb-1 position-relative report-widget-title-row">
        <h5 class="mb-0 flex-grow-1">{{ widget.reportDefinition.name }}</h5>
        <a href="{{ path('app_report_builder', {id: widget.reportDefinition.id}) }}"
           class="report-edit-icon ms-2"
           title="Edit report">
            <i class="fas fa-edit"></i>
        </a>
    </div>
    <div id="report-chart-{{ widget.id }}" class="report-chart-container mb-2">
        <canvas id="report-canvas-{{ widget.id }}" height="180"></canvas>
        <div id="report-error-{{ widget.id }}" class="text-danger small mt-2" style="display:none"></div>
    </div>
    <script>
    (function() {
        const chartId = '{{ widget.id|json_encode }}';
        const apiUrl = '/api/report/widget/' + chartId + '/data';
        const canvas = document.getElementById('report-canvas-' + chartId);
        const errorDiv = document.getElementById('report-error-' + chartId);
        if (!canvas) return;
        fetch(apiUrl)
            .then(r => {
                if (!r.ok) {
                    throw new Error('HTTP ' + r.status + ' ' + r.statusText);
                }
                return r.json();
            })
            .then(data => {
                if (data.error) {
                    errorDiv.textContent = data.error;
                    errorDiv.style.display = 'block';
                    console.error('Report API error:', data.error);
                    return;
                }
                const chartType = data.diagramType || 'bar';
                new Chart(
                    canvas, {
                        type: chartType,
                        data: {
                            labels: data.labels,
                            datasets: data.datasets
                        }
                    }
                );
            });
    })();
    </script>
</div>
